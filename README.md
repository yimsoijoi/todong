# todong
todong (todo next-gen) is a small HTTP back-end server for managing to-do lists. It is my personal project, with the goal to practice writing production-level code. The main goal of the project is to be a very flexible to-do list back-end.

## Features

- **Configurable web frameworks** - choose between [Gin](https://github.com/gin-gonic/gin) or [Fiber](https://github.com/gofiber/fiber), easily with one line in the YAML config file! (e.g. `server: gin`).

- **Configurable data store**, choose between Postgres (via [Gorm](https://gorm.io)) or [Redis](https://redis.io), easily with one line in the YAML config file! (e.g. `store: redis`). For more info, see [package store](/store/)

- JWT authentication - users can only view and manage their own to-do lists. JWT is issued during logins, while the authentication middleware is in `lib/middleware/authenticate.go`. Both Gin and Fiber handlers utilize their own *but compatible* authorization middleware.

- YAML configuration. For more info, see [package config](/config/)

## Important interfaces

### `httpserver.Server`
`Server` interface abstracts the HTTP servers with `SetUpRoutes()` and `Serve(addr string) error`. `ginserver.ginServer` and `fiberserver.fiberServer` implement `httpserver.Server`.

In `main()`, it calls `httpserver.New()` which takes in a `handler.Adapter`.

### `handler.Adapter`
`Adapter` abstracts over Gin and Fiber handlers. It specifies 2 methods: method `Gin(s string) func(*gin.Context)` returns a Gin handler method, while method `Fiber(s string) func(*fiber.Ctx) error` returns a Fiber handler method.

Struct `handler.adapter` implements this interface, and as of writing it looks like this:

```
// adapter implements Adapter
type adapter struct {
	gin      *ginhandler.GinHandler
	fiber    *fiberhandler.FiberHandler
	ginMap   map[string]func(*gin.Context)
	fiberMap map[string]func(*fiber.Ctx) error
}
func (h *adapter) Gin(s string) func(*gin.Context) {
	if h.ginMap[s] == nil {
		panic(fmt.Sprintf("missing gin handlers for: %s", s))
	}
	return h.ginMap[s]
}
func (h *adapter) Fiber(s string) func(*fiber.Ctx) error {
	if h.fiberMap[s] == nil {
		panic(fmt.Sprintf("missing fiber handlers for: %s", s))
	}
	return h.fiberMap[s]
}
```

The string `s` in `Fiber(s)` and `Gin(s)` is used to retrieve corresponding functions stored in maps generated by `handler.MapHandlers`.

### `store.DataGateway`
`DataGateway` abstracts high-level storage, like `GetUserByUuid()` or `DeleteTodo()`.  There are 2 implementations of this interface:

(1) `redisDataGateway`, which uses the underlying `redis.Cmdable` interface to store and retrieve data in Redis, and

(2) `gormDataGateway`, which uses the underlying `GormStore` interface (implemented by `gormStore`). Struct `gormStore` has a field identified as `GormDB`, which is a subset of `*gorm.DB` methods.

> Actually, `GormStore` is not needed, but it makes `DataGateway` implementation by `gormDataGateway` looks very eleglant, so I decide to keep the useless interface.

## Architecture

![Abstraction](https://github.com/yimsoijoi/todong/blob/main/assets/todogin_arch.png?raw=true)